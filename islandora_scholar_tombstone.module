<?php

/**
 * @file
 * Short file description here.
 *
 * Long description here.
 */

/**
 * Implements hook_menu().
 */
function islandora_scholar_tombstone_menu() {
  $items['example'] = array(
    'title' => 'Example Page',
    'page callback' => 'islandora_scholar_tombstone_page',
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_help().
 */
function islandora_scholar_tombstone_help($path, $arg) {

  switch ($path) {
    case 'admin/help#islandora_scholar_tombstone':

      // Return a line-break version of the README.
      $readme = file_get_contents(drupal_get_path('module', 'islandora_scholar_tombstone') . '/README.txt');
      return nl2br($readme);
  }
}

/**
 * Page example callback, referenced in hook_menu().
 *
 * Description of what the page displays.
 * Second line of the description.
 *
 * @return string
 *   The content of the page.
 */
function islandora_scholar_tombstone_page() {

  return 'Fishes';
}

/**
 * Implements hook_page_build().
 *
 * Add JavaScript and CSS code to every page.
 */
function islandora_scholar_tombstone_page_build() {

  drupal_add_js(drupal_get_path('module', 'islandora_scholar_tombstone') . '/js/islandora_scholar_tombstone.js');
  drupal_add_css(drupal_get_path('module', 'islandora_scholar_tombstone') . '/css/islandora_scholar_tombstone.css');
  $path = drupal_get_path_alias($_GET['q']);
  module_load_include('inc', 'islandora_scholar_embargo', 'includes/utilities');
    $count = FALSE;
  $current_embargo = <<<EOQ
PREFIX is: <info:islandora/islandora-system:def/scholar#>
SELECT ?obj ?date
FROM <#ri>
WHERE {
  ?obj is:embargo-until ?date
}
EOQ;
    if ($count) {
        $current_embargo .= <<<EOQ
ORDER BY ?obj
EOQ;
    }
    $connection = islandora_get_tuque_connection();
    $ri = $connection->repository->ri;
//    dsm($count ? $ri->countQuery($current_embargo, 'sparql') : $ri->sparqlQuery($current_embargo, 'unlimited', '0'));
    $check_embargo = $ri->sparqlQuery($current_embargo, 'unlimited', '0');
//    dsm($check_embargo[0]['date']['value']);
//    dsm(strtotime($check_embargo[0]['date']['value']));
    global $variables;
//    if embargo date is less than current date display message
    if (strtotime($check_embargo[0]['date']['value']) >= time() ) {
        dsm('It is: ', time());
        dsm(strtotime($check_embargo[0]['date']['value']));
        dsm(strtotime($check_embargo[0]['date']['value']) - time());
        dsm($variables);
    }
}


function islandora_scholar_tombstone_custom_page(){
//Example of desired return
//Embargo will expire:
//21-Aug-2017 11:05 AM EDT
//Released to reporters:
//14-Aug-2017 3:00 PM EDT
}