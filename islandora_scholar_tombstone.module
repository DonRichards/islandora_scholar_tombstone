<?php

/**
 * @file
 * Short file description here.
 *
 * Long description here.
 */


/*
 * Looking for if the:
 * Any file datastream isn't
 *  - MODS
 *  - PDF
 *  - Supple# optional with no impact on this feature.
 */

/**
 * Implements hook_menu().
 */
function islandora_scholar_tombstone_menu() {
    $items = array();
    $items['admin/settings/islandora_scholar_tombstone'] = array(
        'title' => 'On this date module settings',
        'description' => 'Description of your On this date settings page',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('islandora_scholar_tombstone'),
        'access arguments' => array('administer islandora_scholar_tombstone settings'),
        'type' => MENU_NORMAL_ITEM,
    );
  return $items;
}

/**
 * Implements hook_help().
 */
function islandora_scholar_tombstone_help($path, $arg) {

  switch ($path) {
    case 'admin/help#islandora_scholar_tombstone':

      // Return a line-break version of the README.
      $readme = file_get_contents(drupal_get_path('module', 'islandora_scholar_tombstone') . '/README.txt');
      return nl2br($readme);
  }
}

/**
 * Page example callback, referenced in hook_menu().
 *
 * Description of what the page displays.
 * Second line of the description.
 *
 * @return string
 *   The content of the page.
 */
function islandora_scholar_tombstone_page() {

  return 'Fishes';
}

/**
 * Implements hook_page_build().
 *
 * Add JavaScript and CSS code to every page.
 */
function islandora_scholar_tombstone_page_build() {
dsm('module is running');
//  drupal_add_js(drupal_get_path('module', 'islandora_scholar_tombstone') . '/js/islandora_scholar_tombstone.js');
//  drupal_add_css(drupal_get_path('module', 'islandora_scholar_tombstone') . '/css/islandora_scholar_tombstone.css');
//  $path = drupal_get_path_alias($_GET['q']);


}

/**
 * Implements hook_page_alter().
 */
function islandora_scholar_tombstone_page_alter(&$page)
{
    dpm($page);

    if (isset($page['content']['system_main']['citation.tab']['preview']['#path'])) {
        unset($page['content']['system_main']['citation.tab']['preview']['#path']);
    }

    module_load_include('inc', 'islandora_scholar_embargo', 'includes/utilities');
    $count = FALSE;
    $current_embargo = <<<EOQ
    PREFIX is: <info:islandora/islandora-system:def/scholar#>
    SELECT ?obj ?date
    FROM <#ri>
        WHERE {
            ?obj is:embargo-until ?date
            }
EOQ;
    if ($count) {
        $current_embargo .= <<<EOQ
        ORDER BY ?obj
        }
EOQ;
    }

$not_current_embargo = <<<EOQ
    PREFIX is: <info:islandora/islandora-system:def/scholar#>
    SELECT ?obj
    FROM <#ri>
        WHERE {
            ?obj
            }
EOQ;
    if ($count) {
        $not_current_embargo .= <<<EOQ
        ORDER BY ?obj
        }
EOQ;
    }
//    dpm(var_dump(get_defined_vars()));
    $connection = islandora_get_tuque_connection();
    $ri = $connection->repository->ri;
    $check_embargo = $ri->sparqlQuery($current_embargo, 'unlimited', '0');



    // ^^^^^^^^^^^^^^^ HERE ^^^^^^^^^^^^^^^^^^^
    $not_check_embargo = $ri->sparqlQuery($not_current_embargo, 'unlimited');
    dpm($not_check_embargo);

//  Looking to get the object's information and pipe it to line 160  





//    dpm($page);
//    dsm($count ? $ri->countQuery($current_embargo, 'sparql') : $ri->sparqlQuery($current_embargo, 'unlimited', '0'));
//    dsm($check_embargo[0]['date']['value']);
//    dsm(strtotime($check_embargo[0]['date']['value']));
//    dpm(trim(current_path(), 'islandora/object'));

//    if embargo date is less than current date display message
    if (isset($check_embargo[0]['date']['value'])) {

        $datastreams_required_for_an_withdrawn_message = array
        (
            array('MODS', NULL),
            array('PDF', NULL)
        );
        $collections_using_this_withdrawn_message = array('utk.ir.td');

//        dsm('Indefinite embargo found: ', time());


//        Object Level Embargo
        if ($check_embargo[0]['date']['value'] == 'indefinite') {
            $page['content']['system_main']['nodes'][8]['body'][0]['#markup'] = t('
                    <h1>@title</h1>
                    <p>What?</p>
                    ', array('@title' => $current_embargo));
        } else {
            foreach ($check_embargo as $key => $value) {
                if ($value['date']['value'] == 'indefinite') {

                } elseif (strtotime($value['date']['value']) <= time()) {
//                dpm('In time');
//                dsm(date('M d Y', strtotime($check_embargo[0]['date']['value'])));
//                dsm(strtotime($check_embargo[0]['date']['value']) - time());

//
                    if ($page['content']['system_main']['citation.tab']['citation']['#markup'] == 'Unable to load MODS.') {
                        $page['content']['system_main']['citation.tab']['citation']['#markup'] = t("This resource will be 
                    available on !time_until_embargo_is_lifted", array('!time_until_embargo_is_lifted' =>
                            format_string(date('M d Y', strtotime($check_embargo[0]['date']['value'])))));
                    }

//                dpm(trim(current_path(), 'islandora/object'));
                }
            }
            // dsm($ri->sparqlQuery($current_embargo));
        }
    }
//    Retraction Notice instead.

    //Example of desired return
//Embargo will expire:
//21-Aug-2017 11:05 AM EDT
//Released to reporters:
//14-Aug-2017 3:00 PM EDT
}


function islandora_scholar_tombstone_admin() {
    $form = array();

    $form['islandora_scholar_tombstone_datastreams'] = array(
        '#type' => 'textfield',
        '#title' => t('Datastreams Required'),
        '#default_value' => variable_get('islandora_scholar_tombstone_datastreams'),
        '#description' => t("Give a list of datastreams to look for /n Examples: 'MODS','PDF' ."),
        '#required' => TRUE,
    );

    return system_settings_form($form);
}
